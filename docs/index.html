<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quant Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0d1117;
    color: #c9d1d9;
    padding: 24px;
    line-height: 1.5;
}
.container { max-width: 1400px; margin: 0 auto; }

/* Header */
.header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
}
.header h1 {
    font-size: 1.8em;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.subtitle { color: #8b949e; font-size: 0.95em; margin-top: 4px; }
.header-right { text-align: right; }
.timestamp { color: #8b949e; font-size: 0.85em; margin-top: 4px; }

/* Market status badge */
.market-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
}
.market-badge.open     { background: #238636; color: #fff; }
.market-badge.closed   { background: #30363d; color: #8b949e; }
.market-badge.extended { background: #9e6a03; color: #fff; }

/* Metric cards */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
}
.metric-card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 10px;
    padding: 20px;
    transition: border-color 0.2s;
}
.metric-card:hover { border-color: #667eea; }
.metric-label { color: #8b949e; font-size: 0.82em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.metric-value { font-size: 1.6em; font-weight: 700; }

/* Positive / Negative */
.positive { color: #3fb950; }
.negative { color: #f85149; }

/* Sections */
.section {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 10px;
    padding: 24px;
    margin-bottom: 24px;
}
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.section-title { font-size: 1.2em; font-weight: 600; margin-bottom: 16px; }
.section-header .section-title { margin-bottom: 0; }

/* Tables */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th {
    text-align: left;
    padding: 10px 14px;
    border-bottom: 2px solid #30363d;
    color: #8b949e;
    font-weight: 500;
    font-size: 0.82em;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
}
td { padding: 10px 14px; border-bottom: 1px solid #21262d; white-space: nowrap; }
tbody tr:hover { background: rgba(102,126,234,0.04); }
tfoot td { border-top: 2px solid #30363d; border-bottom: none; padding-top: 14px; }

/* Badges */
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}
.badge-long   { background: #238636; color: #fff; }
.badge-short  { background: #da3633; color: #fff; }
.badge-buy    { background: #238636; color: #fff; }
.badge-sell   { background: #da3633; color: #fff; }
.badge-filled { background: #1f6feb; color: #fff; }
.badge-closed { background: #30363d; color: #8b949e; }

/* After-hours info */
.ah-badge {
    font-size: 0.8em;
    color: #d29922;
    margin-top: 2px;
}
.stock-name { font-size: 0.78em; color: #8b949e; }

/* Live dot */
.live-dot { color: #3fb950; }
.live-dot::before { content: ''; display: inline-block; width: 8px; height: 8px; background: #3fb950; border-radius: 50%; margin-right: 6px; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

/* Price status */
.price-status { font-size: 0.85em; color: #8b949e; }

/* Price flash animation */
@keyframes priceFlash {
    0%   { background: rgba(102,126,234,0.3); }
    100% { background: transparent; }
}
.price-flash { animation: priceFlash 1.2s ease-out; }

/* Chart */
.chart-container { height: 350px; position: relative; }
.chart-container.chart-lg { height: 400px; }

/* Broker-style equity header */
.equity-section { padding-bottom: 16px; }
.equity-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
    flex-wrap: wrap;
    gap: 12px;
}
.equity-header-left { min-width: 200px; }
.equity-value {
    font-size: 2.2em;
    font-weight: 700;
    letter-spacing: -0.5px;
    transition: color 0.3s;
}
.equity-change {
    font-size: 0.95em;
    font-weight: 500;
    margin-top: 2px;
}
.equity-range-label {
    color: #8b949e;
    font-size: 0.85em;
    margin-left: 4px;
}

/* Watchlist dropdown */
#watchlist-select {
    background: #21262d;
    border: 1px solid #30363d;
    color: #c9d1d9;
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 0.85em;
    font-weight: 600;
    cursor: pointer;
    outline: none;
    min-width: 160px;
}
#watchlist-select:hover, #watchlist-select:focus { border-color: #667eea; }
#watchlist-select option { background: #161b22; color: #c9d1d9; }

/* Toggle groups (equity range) */
.toggle-group { display: flex; gap: 4px; flex-wrap: wrap; }
.toggle-btn {
    background: #21262d;
    border: 1px solid #30363d;
    color: #8b949e;
    padding: 4px 14px;
    border-radius: 6px;
    font-size: 0.82em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.toggle-btn:hover { border-color: #667eea; color: #c9d1d9; }
.toggle-btn.active { background: #667eea; color: #fff; border-color: #667eea; }

/* Watchlist */
.watch-info-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border: 1px solid #21262d;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    gap: 16px;
}
.watch-info-row:hover { border-color: #667eea; background: rgba(102,126,234,0.04); }
.watch-info-row.active { border-color: #667eea; background: rgba(102,126,234,0.08); }
.watch-info-left { min-width: 120px; }
.watch-info-mid { display: flex; align-items: center; gap: 12px; flex: 1; flex-wrap: wrap; }
.watch-detail-inline { color: #8b949e; font-size: 0.82em; }
.watch-links { display: flex; gap: 6px; }
.watch-links a {
    color: #667eea;
    text-decoration: none;
    font-size: 0.82em;
    font-weight: 600;
    padding: 3px 10px;
    border: 1px solid #30363d;
    border-radius: 4px;
    transition: all 0.2s;
}
.watch-links a:hover { background: #667eea; color: #fff; border-color: #667eea; }
.watch-price {
    font-size: 1.1em;
    font-weight: 700;
}
.tradingview-widget {
    margin-top: 12px;
    margin-bottom: 12px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #21262d;
}

/* Footer */
.footer {
    text-align: center;
    color: #484f58;
    font-size: 0.82em;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #21262d;
}
.footer a { color: #667eea; text-decoration: none; }
.footer a:hover { text-decoration: underline; }

.muted { color: #484f58; font-style: italic; }

/* Responsive */
@media (max-width: 768px) {
    body { padding: 12px; }
    .header { flex-direction: column; }
    .header-right { text-align: left; }
    .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    .metric-value { font-size: 1.3em; }
    .watchlist-grid { grid-template-columns: 1fr; }
}

    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>Quant Trading Dashboard</h1>
                <div class="subtitle">Mean Reversion Strategy &middot; Alpaca Paper Trading</div>
            </div>
            <div class="header-right">
                <div id="market-status" class="market-badge">Loading...</div>
                <div id="last-update" class="timestamp"></div>
                <div id="refresh-countdown" class="timestamp"></div>
            </div>
        </header>

        <!-- Account Summary Cards -->
        <div class="metrics-grid" id="metrics-grid"></div>

        <!-- Positions -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Open Positions</div>
                <div id="price-status" class="price-status"></div>
            </div>
            <div id="positions-table" class="table-wrap"></div>
        </div>

        <!-- Watchlist / TradingView Charts -->
        <div class="section" id="watchlist-section" style="display:none;">
            <div class="section-header">
                <div class="section-title">Watchlist &amp; Charts</div>
                <select id="watchlist-select" onchange="selectWatchSymbol(this.value || null)"></select>
            </div>
            <div id="watchlist-chart" style="display:none;"></div>
            <div id="watchlist-info"></div>
        </div>

        <!-- Equity Curve (Broker-style) -->
        <div class="section equity-section">
            <div class="equity-header">
                <div class="equity-header-left">
                    <div id="equity-value" class="equity-value">$0.00</div>
                    <div id="equity-change" class="equity-change"></div>
                </div>
                <div id="equity-range-toggle" class="toggle-group">
                    <button class="toggle-btn" data-range="1d" onclick="setEquityRange('1d')">1D</button>
                    <button class="toggle-btn" data-range="1m" onclick="setEquityRange('1m')">1M</button>
                    <button class="toggle-btn" data-range="3m" onclick="setEquityRange('3m')">3M</button>
                    <button class="toggle-btn" data-range="1y" onclick="setEquityRange('1y')">1Y</button>
                    <button class="toggle-btn active" data-range="all" onclick="setEquityRange('all')">All</button>
                </div>
            </div>
            <div class="chart-container chart-lg">
                <canvas id="equityChart"></canvas>
            </div>
            <p id="no-equity" class="muted" style="display:none;">
                Equity curve data will appear after trading cycles accumulate snapshots.
            </p>
        </div>

        <!-- Recent Trades -->
        <div class="section">
            <div class="section-title">Recent Trades</div>
            <div id="trades-table" class="table-wrap"></div>
        </div>

        <footer class="footer">
            Dashboard data pushed after each trading cycle &middot;
            Live prices fetched from Yahoo Finance every 5s &middot;
            <a href="https://github.com/Shimmy-Shams/Quant" target="_blank">GitHub</a>
        </footer>
    </div>

    <script>
    // ── Embedded server-side data ─────────────────────────────────────────
    const DATA = {"positions": [{"symbol": "CRWD", "side": "long", "qty": 232.0, "entry_price": 413.960733, "current_price": 415.805, "market_value": 96466.76, "pnl": 427.869944, "pnl_pct": 0.44600000000000006}, {"symbol": "ETHUSD", "side": "long", "qty": 0.012291251, "entry_price": 0.0, "current_price": 1943.921, "market_value": 23.893221, "pnl": 23.893221, "pnl_pct": 0.0}], "trades": [{"symbol": "CRWD", "side": "buy", "qty": 232.0, "price": 413.960733, "date": "2026-02-17", "status": "filled"}, {"symbol": "ETH/USD", "side": "buy", "qty": 0.0, "price": 1989.4, "date": "2026-02-17", "status": "filled"}, {"symbol": "BTC/USD", "side": "sell", "qty": 0.000356827, "price": 68441.72, "date": "2026-02-17", "status": "filled"}, {"symbol": "BTC/USD", "side": "buy", "qty": 0.0, "price": 68504.9, "date": "2026-02-17", "status": "filled"}], "account": {"equity": 1000403.57, "cash": 903911.76, "portfolio_value": 1000403.57, "buying_power": 1904291.44}, "equity_curve": [{"date": "2026-02-18 09:03", "equity": 999779.6}, {"date": "2026-02-18 09:09", "equity": 999779.6}, {"date": "2026-02-18 09:22", "equity": 999606.38}, {"date": "2026-02-18 09:31", "equity": 999569.28}, {"date": "2026-02-18 09:42", "equity": 999569.34}, {"date": "2026-02-18 09:48", "equity": 999569.34}, {"date": "2026-02-18 09:58", "equity": 999569.27}, {"date": "2026-02-18 09:59", "equity": 999569.27}, {"date": "2026-02-18 10:03", "equity": 999569.27}, {"date": "2026-02-18 20:55", "equity": 1000436.04}, {"date": "2026-02-18 20:59", "equity": 1000403.57}], "metrics": {"portfolio_value": 1000403.57, "cash": 903911.76, "buying_power": 1904291.44, "total_return_pct": 0.040356999999994876, "total_trades": 4, "win_rate": 0.0, "sharpe_ratio": 3.4436594661330195, "max_drawdown": 0.021037636695123416}, "server_quotes": {"CRWD": {"price": 415.8, "change": 9.0933, "changePct": 2.2358, "previousClose": 406.7067, "dayHigh": 421.7, "dayLow": 402.0, "volume": 1629676, "name": "CrowdStrike Holdings, Inc.", "marketState": "REGULAR", "prePrice": null, "preChange": null, "preChangePct": null, "postPrice": null, "postChange": null, "postChangePct": null}, "ETHUSD": {"price": 1942.1522, "change": -50.3765, "changePct": -2.5283, "previousClose": 1992.5287, "dayHigh": 2035.6812, "dayLow": 1926.7258, "volume": 15374082048, "name": "Ethereum USD", "marketState": "REGULAR", "prePrice": null, "preChange": null, "preChangePct": null, "postPrice": null, "postChange": null, "postChangePct": null}}, "generated_utc": "2026-02-18 20:59:32"};

    // ── Configuration ─────────────────────────────────────────────────────
    const REFRESH_INTERVAL = 5;           // seconds between price refreshes
    const INITIAL_CAPITAL   = 1000000;
    const CORS_PROXIES = [
        url => 'https://corsproxy.io/?' + encodeURIComponent(url),
        url => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url),
    ];

    let countdown = REFRESH_INTERVAL;

    // ── Time-based market state detection ──────────────────────────────────
    // Crypto symbols trade 24/7 and are always REGULAR
    const CRYPTO_SYMS = new Set(['ETHUSD','BTCUSD','SOLUSD','XRPUSD','DOGEUSD','ETCUSD','AVAXUSD','ADAUSD','SHIBUSD','LINKUSD','DOTUSD','LTCUSD','UNIUSD','BCHUSD','AAVEUSD']);
    function isCrypto(symbol) { return CRYPTO_SYMS.has(symbol) || /USD$/.test(symbol); }

    function getCurrentMarketState(symbol) {
        // Crypto = always open
        if (isCrypto(symbol)) return 'REGULAR';

        // Determine current Eastern Time
        const now = new Date();
        const etStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
        const et = new Date(etStr);
        const day = et.getDay();   // 0=Sun .. 6=Sat
        const h = et.getHours();
        const m = et.getMinutes();
        const minutes = h * 60 + m;  // minutes since midnight ET

        // Weekend = CLOSED
        if (day === 0 || day === 6) return 'CLOSED';

        // Pre-market:  4:00 AM – 9:29 AM ET
        if (minutes >= 240 && minutes < 570) return 'PRE';
        // Regular:     9:30 AM – 3:59 PM ET
        if (minutes >= 570 && minutes < 960) return 'REGULAR';
        // Post-market: 4:00 PM – 7:59 PM ET
        if (minutes >= 960 && minutes < 1200) return 'POST';
        // Outside all sessions
        return 'CLOSED';
    }

    // Seed with server-side quotes but override marketState with time-based values
    let liveQuotes = {};
    {
        const sq = DATA.server_quotes || {};
        for (const sym of Object.keys(sq)) {
            liveQuotes[sym] = Object.assign({}, sq[sym], { marketState: getCurrentMarketState(sym) });
        }
    }
    let equityChart = null;
    let activeWatchSymbol = null;
    let renderedChartSymbol = null;  // tracks which symbol's iframe is loaded
    let currentEquityRange = 'all';
    let fetchCount = 0;
    let lastPrices = {};  // track previous prices for flash animation

    // ── Utilities ─────────────────────────────────────────────────────────
    const fmt  = (v, d=2) => v == null ? '—' : v.toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d});
    const fmtD = (v)      => v == null ? '—' : '$' + fmt(v);
    const fmtP = (v)      => v == null ? '—' : (v >= 0 ? '+' : '') + fmt(v) + '%';
    const cls  = (v)      => v >= 0 ? 'positive' : 'negative';

    // ── Yahoo Finance live price fetcher ──────────────────────────────────
    function toYahooSymbol(s) {
        if (s.endsWith('USD') && s.length <= 7 && !s.includes('-'))
            return s.slice(0, -3) + '-USD';
        return s;
    }

    // Fetch a single symbol via Yahoo v8 chart endpoint (more reliable than v7 quote)
    async function fetchOneQuote(symbol) {
        const yahooSym = toYahooSymbol(symbol);
        const cacheBust = Date.now() + '_' + (fetchCount++);
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSym}?range=1d&interval=1m&includePrePost=true&_=${cacheBust}`;

        for (const makeProxy of CORS_PROXIES) {
            try {
                const resp = await fetch(makeProxy(url), {
                    signal: AbortSignal.timeout(6000),
                    cache: 'no-store',
                    headers: { 'Cache-Control': 'no-cache, no-store', 'Pragma': 'no-cache' }
                });
                if (!resp.ok) continue;
                const json = await resp.json();
                const result = json?.chart?.result?.[0];
                if (!result) continue;
                const meta = result.meta;
                const prevClose = meta.chartPreviousClose || meta.previousClose;
                const price = meta.regularMarketPrice;
                const change = price - prevClose;
                const changePct = prevClose ? (change / prevClose) * 100 : 0;
                // Day high/low from indicators
                const closes = result.indicators?.quote?.[0]?.close || [];
                const highs  = result.indicators?.quote?.[0]?.high || [];
                const lows   = result.indicators?.quote?.[0]?.low || [];
                const vols   = result.indicators?.quote?.[0]?.volume || [];
                const validHighs = highs.filter(v => v != null);
                const validLows  = lows.filter(v => v != null);
                const totalVol   = vols.reduce((a,b) => a + (b||0), 0);
                return {
                    price, change, changePct,
                    marketState:   meta.marketState || 'UNKNOWN',
                    prePrice:      meta.preMarketPrice || null,
                    preChange:     meta.preMarketPrice ? meta.preMarketPrice - prevClose : null,
                    preChangePct:  meta.preMarketPrice && prevClose ? ((meta.preMarketPrice - prevClose)/prevClose)*100 : null,
                    postPrice:     meta.postMarketPrice || null,
                    postChange:    meta.postMarketPrice ? meta.postMarketPrice - prevClose : null,
                    postChangePct: meta.postMarketPrice && prevClose ? ((meta.postMarketPrice - prevClose)/prevClose)*100 : null,
                    name:          meta.shortName || meta.symbol || yahooSym,
                    dayHigh:       validHighs.length ? Math.max(...validHighs) : null,
                    dayLow:        validLows.length  ? Math.min(...validLows) : null,
                    volume:        totalVol || meta.regularMarketVolume || null,
                    avgVolume:     null,
                    fiftyTwoHigh:  meta.fiftyTwoWeekHigh || null,
                    fiftyTwoLow:   meta.fiftyTwoWeekLow || null,
                    previousClose: prevClose,
                };
            } catch (e) {
                console.warn('Proxy failed for', symbol, ':', e.message);
            }
        }
        return null;
    }

    async function fetchLiveQuotes(symbols) {
        if (!symbols.length) return {};
        const results = await Promise.allSettled(symbols.map(s => fetchOneQuote(s)));
        const out = {};
        results.forEach((r, i) => {
            if (r.status === 'fulfilled' && r.value) out[symbols[i]] = r.value;
        });
        return out;
    }

    // ── Render helpers ────────────────────────────────────────────────────

    function renderMetrics() {
        const m = DATA.metrics;
        const a = DATA.account;
        const pv = livePortfolioValue();
        const dayPnl = calculateDayPnl();

        const cards = [
            { label: 'Portfolio Value', value: fmtD(pv), cls: '' },
            { label: 'Cash', value: fmtD(a.cash), cls: '' },
            { label: 'Day P&L', value: fmtD(dayPnl), cls: cls(dayPnl) },
            { label: 'Total Return', value: fmtP(((pv - INITIAL_CAPITAL) / INITIAL_CAPITAL) * 100), cls: cls(pv - INITIAL_CAPITAL) },
            { label: 'Open Positions', value: DATA.positions.length, cls: '' },
            { label: 'Trades Executed', value: m.total_trades, cls: '' },
        ];

        document.getElementById('metrics-grid').innerHTML = cards.map(c => `
            <div class="metric-card">
                <div class="metric-label">${c.label}</div>
                <div class="metric-value ${c.cls}">${c.value}</div>
            </div>
        `).join('');
    }

    function calculateDayPnl() {
        let total = 0;
        for (const p of DATA.positions) {
            const q = liveQuotes[p.symbol];
            if (q && q.previousClose) {
                const curPrice = effectivePrice(p.symbol, q) || p.current_price;
                const dayChange = curPrice - q.previousClose;
                total += dayChange * Math.abs(p.qty) * (p.side === 'short' ? -1 : 1);
            }
        }
        return total;
    }

    function livePortfolioValue() {
        let positionValue = 0;
        for (const p of DATA.positions) {
            const q = liveQuotes[p.symbol];
            const curPrice = effectivePrice(p.symbol, q) || p.current_price;
            const mktVal = curPrice * Math.abs(p.qty);
            positionValue += p.side === 'short' ? -mktVal : mktVal;
        }
        if (Object.keys(liveQuotes).length > 0 && DATA.positions.length > 0) {
            return DATA.account.cash + positionValue;
        }
        return DATA.account.portfolio_value || INITIAL_CAPITAL;
    }

    function effectivePrice(symbol, quote) {
        if (!quote) return null;
        const state = (quote.marketState || '').toUpperCase();
        // Post-market states: POST, POSTPOST, CLOSED
        if ((state === 'POST' || state === 'POSTPOST' || state === 'CLOSED') && quote.postPrice)
            return quote.postPrice;
        // Pre-market states: PRE, PREPRE
        if ((state === 'PRE' || state === 'PREPRE') && quote.prePrice)
            return quote.prePrice;
        return quote.price;
    }

    function priceLabel(quote) {
        if (!quote) return '';
        const state = (quote.marketState || '').toUpperCase();
        if ((state === 'POST' || state === 'POSTPOST' || state === 'CLOSED') && quote.postPrice)
            return 'AH';
        if ((state === 'PRE' || state === 'PREPRE') && quote.prePrice)
            return 'PM';
        if (state === 'REGULAR')
            return 'LIVE';
        return '';
    }

    function renderPositions() {
        const positions = DATA.positions;
        if (!positions.length) {
            document.getElementById('positions-table').innerHTML =
                '<p class="muted">No open positions</p>';
            return;
        }

        const pv = livePortfolioValue();
        let rows = '';
        let totalPnl = 0;
        let totalMktVal = 0;

        for (const p of positions) {
            const q = liveQuotes[p.symbol];
            const livePrice = effectivePrice(p.symbol, q);
            const curPrice = livePrice || p.current_price;
            const pnl = p.side === 'short'
                ? (p.entry_price - curPrice) * Math.abs(p.qty)
                : (curPrice - p.entry_price) * Math.abs(p.qty);
            const costBasis = p.entry_price * Math.abs(p.qty);
            const pnlPct = costBasis > 0 ? (pnl / costBasis) * 100 : 0;
            const mktVal = curPrice * Math.abs(p.qty);
            const pctOfPortfolio = pv > 0 ? (mktVal / pv) * 100 : 0;
            totalPnl += pnl;
            totalMktVal += mktVal;

            // Day change from Yahoo
            let dayChangePct = null;
            let dayChangeAmt = null;
            if (q) {
                dayChangePct = q.changePct;
                dayChangeAmt = q.change;
            }

            // After-hours / pre-market badge
            let ahBadge = '';
            if (q) {
                const pLabel = priceLabel(q);
                const state = (q.marketState || '').toUpperCase();
                if (pLabel === 'AH') {
                    const chg = q.postPrice - q.price;
                    const chgPct = q.price ? (chg / q.price) * 100 : 0;
                    ahBadge = `<div class="ah-badge">AH <span class="${cls(chg)}">${fmtP(chgPct)}</span></div>`;
                } else if (pLabel === 'PM') {
                    const chg = q.prePrice - q.price;
                    const chgPct = q.price ? (chg / q.price) * 100 : 0;
                    ahBadge = `<div class="ah-badge">PM <span class="${cls(chg)}">${fmtP(chgPct)}</span></div>`;
                } else if (pLabel === 'LIVE') {
                    ahBadge = `<div class="ah-badge live-dot">LIVE</div>`;
                }
            }

            rows += `<tr>
                <td>
                    <strong>${p.symbol}</strong>
                    ${q ? `<div class="stock-name">${q.name || ''}</div>` : ''}
                </td>
                <td><span class="badge badge-${p.side}">${p.side.toUpperCase()}</span></td>
                <td>${Math.abs(p.qty)}</td>
                <td>$${fmt(p.entry_price)}</td>
                <td data-sym="${p.symbol}">
                    $${fmt(curPrice)}
                    ${ahBadge}
                </td>
                <td class="${dayChangePct != null ? cls(dayChangePct) : ''}">${dayChangePct != null ? fmtP(dayChangePct) : '—'}</td>
                <td>$${fmt(mktVal)}</td>
                <td>${fmt(pctOfPortfolio, 1)}%</td>
                <td class="${cls(pnl)}">$${fmt(pnl)}</td>
                <td class="${cls(pnlPct)}">${fmtP(pnlPct)}</td>
            </tr>`;
        }

        document.getElementById('positions-table').innerHTML = `
            <table>
                <thead><tr>
                    <th>Symbol</th><th>Side</th><th>Qty</th>
                    <th>Entry</th><th>Current</th><th>Day Chg</th>
                    <th>Mkt Value</th><th>% Port</th>
                    <th>P&amp;L</th><th>P&amp;L %</th>
                </tr></thead>
                <tbody>${rows}</tbody>
                <tfoot><tr>
                    <td colspan="6" style="text-align:right;font-weight:600;">Totals</td>
                    <td style="font-weight:600;">$${fmt(totalMktVal)}</td>
                    <td style="font-weight:600;">${fmt(pv > 0 ? (totalMktVal / pv) * 100 : 0, 1)}%</td>
                    <td class="${cls(totalPnl)}" style="font-weight:600;">$${fmt(totalPnl)}</td>
                    <td></td>
                </tr></tfoot>
            </table>`;
    }

    function toTvSymbol(s) {
        return (s.endsWith('USD') && s.length <= 7 && !s.includes('-'))
            ? 'COINBASE:' + s.slice(0,-3) + 'USD' : s;
    }

    function renderWatchlist() {
        const positions = DATA.positions;
        if (!positions.length) {
            document.getElementById('watchlist-section').style.display = 'none';
            return;
        }

        document.getElementById('watchlist-section').style.display = 'block';

        // Build dropdown selector
        const selectEl = document.getElementById('watchlist-select');
        let opts = `<option value=""${!activeWatchSymbol ? ' selected' : ''}>Select a symbol…</option>`;
        opts += positions.map(p => {
            return `<option value="${p.symbol}"${activeWatchSymbol === p.symbol ? ' selected' : ''}>${p.symbol}</option>`;
        }).join('');
        selectEl.innerHTML = opts;

        // Render info cards for all positions (compact, no charts)
        const infoCards = positions.map(p => {
            const q = liveQuotes[p.symbol];
            const yahooSym = toYahooSymbol(p.symbol);
            const tvSymbol = toTvSymbol(p.symbol);
            let priceInfo = '';
            if (q) {
                priceInfo = `
                    <span class="watch-price">$${fmt(q.price)}</span>
                    <span class="${cls(q.changePct)}">${fmtP(q.changePct)}</span>
                    <span class="watch-detail-inline">H:$${fmt(q.dayHigh)} L:$${fmt(q.dayLow)}</span>
                    <span class="watch-detail-inline">Vol:${q.volume ? (q.volume/1e6).toFixed(1)+'M' : '—'}</span>
                `;
            }
            return `<div class="watch-info-row ${activeWatchSymbol === p.symbol ? 'active' : ''}" onclick="selectWatchSymbol('${p.symbol}')">
                <div class="watch-info-left">
                    <strong>${p.symbol}</strong>
                    ${q ? `<span class="stock-name">${q.name}</span>` : ''}
                </div>
                <div class="watch-info-mid">${priceInfo}</div>
                <div class="watch-links">
                    <a href="https://finance.yahoo.com/quote/${yahooSym}" target="_blank" onclick="event.stopPropagation()">Y!</a>
                    <a href="https://www.tradingview.com/chart/?symbol=${tvSymbol}" target="_blank" onclick="event.stopPropagation()">TV</a>
                </div>
            </div>`;
        }).join('');
        document.getElementById('watchlist-info').innerHTML = infoCards;

        // Render chart ONLY if selected symbol actually changed (avoid iframe reload)
        updateWatchlistChart();
    }

    function updateWatchlistChart() {
        const chartEl = document.getElementById('watchlist-chart');
        if (activeWatchSymbol) {
            if (renderedChartSymbol !== activeWatchSymbol) {
                const tvSymbol = toTvSymbol(activeWatchSymbol);
                chartEl.style.display = 'block';
                chartEl.innerHTML = `
                    <div class="tradingview-widget">
                        <iframe src="https://s.tradingview.com/widgetembed/?symbol=${tvSymbol}&interval=D&hidesidetoolbar=1&symboledit=0&saveimage=0&toolbarbg=0d1117&studies=[]&theme=dark&style=1&timezone=exchange&withdateranges=0&showpopupbutton=0&studies_overrides=%7B%7D&overrides=%7B%7D&enabled_features=[]&disabled_features=[]&locale=en&utm_source=&utm_medium=widget&utm_campaign=chart&hideideas=1&hidevolume=0&padding=0"
                            style="width:100%;height:450px;border:none;" allowtransparency="true"></iframe>
                    </div>`;
                renderedChartSymbol = activeWatchSymbol;
            }
        } else {
            chartEl.style.display = 'none';
            chartEl.innerHTML = '';
            renderedChartSymbol = null;
        }
    }

    function selectWatchSymbol(symbol) {
        activeWatchSymbol = symbol || null;
        renderWatchlist();
    }

    function renderTrades() {
        const trades = DATA.trades;
        if (!trades.length) {
            document.getElementById('trades-table').innerHTML =
                '<p class="muted">No trades yet</p>';
            return;
        }
        let rows = trades.map(t => `
            <tr>
                <td><strong>${t.symbol}</strong></td>
                <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                <td>${t.qty}</td>
                <td>$${fmt(t.price)}</td>
                <td>${t.date}</td>
                <td>${t.pnl_pct != null ? `<span class="${cls(t.pnl_pct)}">${fmtP(t.pnl_pct)}</span>` : '—'}</td>
                <td><span class="badge badge-filled">${t.status}</span></td>
            </tr>
        `).join('');

        document.getElementById('trades-table').innerHTML = `
            <table>
                <thead><tr>
                    <th>Symbol</th><th>Side</th><th>Qty</th>
                    <th>Price</th><th>Date</th><th>P&amp;L</th><th>Status</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
    }

    // ── Intraday equity accumulator (dense, every 5s refresh) ──────────
    let intradayEquity = [];  // dense intra-day points for 1D view

    function getEquityDataForRange(range) {
        // For 1D, use intraday array if we have points
        if (range === '1d') {
            if (intradayEquity.length > 0) {
                return intradayEquity.map(p => ({
                    date: p.time.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'}),
                    equity: p.equity,
                    isLive: true,
                }));
            }
        }

        const eq = DATA.equity_curve;
        if (!eq.length) return [];
        if (range === 'all') return eq;

        const now = new Date();
        let cutoff;
        switch(range) {
            case '1d': cutoff = new Date(now - 24*60*60*1000); break;
            case '1m': cutoff = new Date(now.getFullYear(), now.getMonth()-1, now.getDate()); break;
            case '3m': cutoff = new Date(now.getFullYear(), now.getMonth()-3, now.getDate()); break;
            case '1y': cutoff = new Date(now.getFullYear()-1, now.getMonth(), now.getDate()); break;
            default:   return eq;
        }
        return eq.filter(d => {
            if (d.isLive) return true;
            const dt = new Date(d.isoDate || d.date);
            return !isNaN(dt) && dt >= cutoff;
        });
    }

    function setEquityRange(range) {
        currentEquityRange = range;
        document.querySelectorAll('#equity-range-toggle .toggle-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.range === range);
        });
        renderEquityChart();
    }

    // ── Crosshair / vertical-line plugin ──────────────────────────────────
    const crosshairPlugin = {
        id: 'crosshairLine',
        afterDraw(chart) {
            if (chart._crosshairX == null) return;
            const ctx = chart.ctx;
            const yAxis = chart.scales.y;
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(chart._crosshairX, yAxis.top);
            ctx.lineTo(chart._crosshairX, yAxis.bottom);
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'rgba(139,148,158,0.5)';
            ctx.setLineDash([4, 3]);
            ctx.stroke();
            ctx.restore();
        }
    };

    function updateEquityHeader(currentVal, startVal) {
        const el = document.getElementById('equity-value');
        const chEl = document.getElementById('equity-change');
        el.textContent = '$' + currentVal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        const diff = currentVal - startVal;
        const pct = startVal > 0 ? (diff / startVal) * 100 : 0;
        const sign = diff >= 0 ? '+' : '';
        const color = diff >= 0 ? '#3fb950' : '#f85149';
        const rangeLabels = { '1d': 'Today', '1m': 'Past Month', '3m': 'Past 3 Months', '1y': 'Past Year', 'all': 'All Time' };
        chEl.innerHTML = `<span style="color:${color}">${sign}$${Math.abs(diff).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} (${sign}${pct.toFixed(2)}%)</span>  <span class="equity-range-label">${rangeLabels[currentEquityRange] || ''}</span>`;
        el.style.color = color;
    }

    function renderEquityChart() {
        const eq = getEquityDataForRange(currentEquityRange);
        if (!eq.length) {
            document.getElementById('no-equity').style.display = 'block';
            return;
        }
        document.getElementById('no-equity').style.display = 'none';

        // Thin large datasets
        let chartData = eq;
        if (eq.length > 600) {
            const step = Math.ceil(eq.length / 600);
            chartData = eq.filter((_, i) => i % step === 0 || i === eq.length - 1);
        }

        const values = chartData.map(d => d.equity);
        const labels = chartData.map(d => d.date);
        const startVal = values[0];
        const endVal   = values[values.length - 1];
        const isUp = endVal >= startVal;

        // Dynamic colors
        const lineColor = isUp ? '#3fb950' : '#f85149';
        const fillColor = isUp ? 'rgba(63,185,80,0.08)' : 'rgba(248,81,73,0.08)';

        // Update P&L header
        updateEquityHeader(endVal, startVal);

        const ctx = document.getElementById('equityChart').getContext('2d');

        // Reference line (starting equity)
        const refLinePlugin = {
            id: 'refLine',
            beforeDraw(chart) {
                const yAxis = chart.scales.y;
                const xAxis = chart.scales.x;
                const yPixel = yAxis.getPixelForValue(startVal);
                if (yPixel < yAxis.top || yPixel > yAxis.bottom) return;
                const cctx = chart.ctx;
                cctx.save();
                cctx.beginPath();
                cctx.moveTo(xAxis.left, yPixel);
                cctx.lineTo(xAxis.right, yPixel);
                cctx.lineWidth = 1;
                cctx.strokeStyle = 'rgba(139,148,158,0.3)';
                cctx.setLineDash([6, 4]);
                cctx.stroke();
                cctx.restore();
            }
        };

        // Gradient fill
        const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.clientHeight);
        gradient.addColorStop(0, isUp ? 'rgba(63,185,80,0.18)' : 'rgba(248,81,73,0.18)');
        gradient.addColorStop(1, 'rgba(13,17,23,0)');

        // Destroy previous chart and recreate (color/gradient changes require it)
        if (equityChart) {
            equityChart.destroy();
            equityChart = null;
        }

        equityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Portfolio Value',
                    data: values,
                    borderColor: lineColor,
                    backgroundColor: gradient,
                    borderWidth: 1.5,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHitRadius: 8,
                }]
            },
            plugins: [refLinePlugin, crosshairPlugin],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: false,  // we use the header instead
                    },
                },
                scales: {
                    y: {
                        grid: { color: '#21262d' },
                        ticks: { color: '#8b949e', callback: v => '$' + v.toLocaleString() }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            color: '#8b949e',
                            maxRotation: 0,
                            autoSkipPadding: 30,
                            maxTicksLimit: 8,
                        }
                    }
                },
                onHover: (event, elements) => {
                    const chart = equityChart;
                    if (!chart) return;
                    const points = chart.getElementsAtEventForMode(event.native, 'index', {intersect: false}, false);
                    if (points.length > 0) {
                        const idx = points[0].index;
                        const hoverVal = values[idx];
                        chart._crosshairX = points[0].element.x;
                        updateEquityHeader(hoverVal, startVal);
                    } else {
                        chart._crosshairX = null;
                        updateEquityHeader(endVal, startVal);
                    }
                    chart.draw();
                }
            }
        });

        // Reset header on mouse leave
        ctx.canvas.addEventListener('mouseleave', () => {
            if (equityChart) {
                equityChart._crosshairX = null;
                equityChart.draw();
            }
            updateEquityHeader(endVal, startVal);
        });
    }

    function renderMarketStatus() {
        const el = document.getElementById('market-status');
        // Use time-based state for the first equity symbol (not crypto)
        const equitySym = DATA.positions.map(p => p.symbol).find(s => !isCrypto(s));
        const state = equitySym ? getCurrentMarketState(equitySym) : 'CLOSED';
        const labels = { REGULAR: 'Market Open', PRE: 'Pre-Market', POST: 'After Hours', CLOSED: 'Market Closed' };
        el.textContent = labels[state] || state;
        el.className = 'market-badge ' + (state === 'REGULAR' ? 'open' : state === 'CLOSED' ? 'closed' : 'extended');
    }

    function updateTimestamps() {
        document.getElementById('last-update').textContent =
            'Data snapshot: ' + DATA.generated_utc + ' UTC';
    }

    // ── Main loop ─────────────────────────────────────────────────────────

    async function refreshPrices() {
        const symbols = DATA.positions.map(p => p.symbol);
        if (symbols.length === 0) return;

        document.getElementById('price-status').textContent = 'Fetching live prices...';
        const quotes = await fetchLiveQuotes(symbols);
        if (Object.keys(quotes).length > 0) {
            // Track price changes for flash animation
            for (const sym of Object.keys(quotes)) {
                if (liveQuotes[sym]) lastPrices[sym] = effectivePrice(sym, liveQuotes[sym]);
            }
            // Merge: use TIME-BASED market state (not stale server snapshot),
            // inherit extended-hours prices from server if client lacks them
            const serverQ = DATA.server_quotes || {};
            for (const sym of Object.keys(quotes)) {
                const cq = quotes[sym];
                const sq = serverQ[sym] || liveQuotes[sym] || {};
                // Always use time-based market state — the CORS API and server
                // snapshot are both unreliable for marketState transitions
                cq.marketState = getCurrentMarketState(sym);
                // Inherit pre/post prices from server if client lacks them
                if (!cq.prePrice  && sq.prePrice)  { cq.prePrice = sq.prePrice; cq.preChange = sq.preChange; cq.preChangePct = sq.preChangePct; }
                if (!cq.postPrice && sq.postPrice) { cq.postPrice = sq.postPrice; cq.postChange = sq.postChange; cq.postChangePct = sq.postChangePct; }
                // Keep server name if client has a generic one
                if ((!cq.name || cq.name === sym) && sq.name) cq.name = sq.name;
            }
            liveQuotes = quotes;
            document.getElementById('price-status').innerHTML =
                '<span class="live-dot">&#9679;</span> Live prices · updated ' + new Date().toLocaleTimeString();
        } else if (Object.keys(liveQuotes).length > 0) {
            // Still have server-side quotes — show that
            document.getElementById('price-status').innerHTML =
                '<span class="live-dot" style="color:#f0ad4e;">&#9679;</span> Server prices (snapshot) · client refresh unavailable';
        } else {
            document.getElementById('price-status').textContent = 'Using cached prices (live fetch unavailable)';
        }

        renderPositions();
        renderMetrics();
        renderMarketStatus();
        renderWatchlist();
        flashUpdatedCells();

        // Append a live equity point from current portfolio value
        appendLiveEquityPoint();
        renderEquityChart();
    }

    function flashUpdatedCells() {
        document.querySelectorAll('[data-sym]').forEach(el => {
            const sym = el.dataset.sym;
            const q = liveQuotes[sym];
            if (q && lastPrices[sym] !== undefined && q.price !== lastPrices[sym]) {
                el.classList.add('price-flash');
                setTimeout(() => el.classList.remove('price-flash'), 1200);
            }
        });
    }

    // Track the last equity value we pushed to avoid duplicate flat points
    let lastLiveEquity = null;

    function appendLiveEquityPoint() {
        if (Object.keys(liveQuotes).length === 0) return;
        const equity = livePortfolioValue();
        if (equity == null || equity <= 0) return;

        const now = new Date();
        const iso = now.toISOString();
        const minuteKey = iso.slice(0, 16);

        // Always push to intradayEquity (dense, for 1D chart)
        intradayEquity.push({ time: now, equity: equity });

        // Don't push duplicate flat values to the main equity_curve
        if (lastLiveEquity !== null && Math.abs(equity - lastLiveEquity) < 0.01) return;
        lastLiveEquity = equity;

        const label = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    + ' ' + now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

        const eq = DATA.equity_curve;
        if (eq.length > 0 && eq[eq.length - 1].isLive) {
            const lastKey = (eq[eq.length - 1].isoDate || '').slice(0, 16);
            if (lastKey === minuteKey) {
                eq[eq.length - 1].equity = equity;
            } else {
                eq.push({ date: label, isoDate: iso, equity: equity, isLive: true });
            }
        } else {
            eq.push({ date: label, isoDate: iso, equity: equity, isLive: true });
        }
    }

    function startCountdown() {
        setInterval(() => {
            countdown--;
            const el = document.getElementById('refresh-countdown');
            if (countdown <= 0) {
                countdown = REFRESH_INTERVAL;
                el.textContent = 'Refreshing...';
                refreshPrices();
            } else {
                el.textContent = `Next refresh: ${countdown}s`;
            }
        }, 1000);
    }

    // ── Init ──────────────────────────────────────────────────────────────
    (async function init() {
        updateTimestamps();

        // Immediately render with server-side quotes (no wait)
        if (Object.keys(liveQuotes).length > 0) {
            document.getElementById('price-status').innerHTML =
                '<span class="live-dot" style="color:#f0ad4e;">&#9679;</span> Server prices (fetching live...)';
        }
        renderMetrics();
        renderPositions();
        renderTrades();
        renderEquityChart();
        renderWatchlist();

        // Then try upgrading to live CORS-proxied quotes
        await refreshPrices();
        startCountdown();
    })();
    </script>
</body>
</html>